# Milvus FAQ 检索系统 - 实验结果分析报告

## 1. 项目概述

本项目构建了一个具备**生产级工程特性**的 RAG 系统。与基础 RAG 不同，本项目重点解决了数据动态同步、并发安全和数据一致性问题。

-   **核心架构**: FastAPI + LlamaIndex + Milvus (Standalone)
-   **工程亮点**:
    -   **增量同步**: 基于文件 MD5 哈希的自动扫描与热更新。
    -   **并发控制**: 实现自定义读写锁（Read-Write Lock），支持多读单写，保证索引更新时的查询稳定性。

## 2. 实验设计与测试结果

### 2.1. 语义检索准确性测试 (基于 bge-small-zh-v1.5)

| 测试场景 | 测试问题 | 匹配内容预览 | 检索得分 | 结论 |
| :--- | :--- | :--- | :--- | :--- |
| **基础匹配** | "什么时候开门？" | 营业时间 9:00-18:00 | 0.3229 | **成功**：准确捕捉语义。 |
| **新增知识** | "不想要了能退吗？" | 支持 7 天无理由退货 | 0.4829 | **成功**：热更新后即刻生效。 |
| **修改更新** | "什么时候开门？" | 营业时间 8:00-22:00 (更新后) | 0.2969 | **成功**：内容已实时刷新。 |
| **删除验证** | "不想要了能退吗？" | (无相关政策说明) | 0.2562 | **成功**：得分大幅下降，一致性同步有效。 |

### 2.2. 工程特性验证 (热更新与一致性)

1.  **文件热更新验证**: 
    -   向 `data/` 目录新增 `faq_add.txt` 后，系统通过 `FileStateManager` 检测到 `added` 状态。
    -   调用 `sync_data_directory` 后，新知识在 **3秒** 内（含 Embedding 计算）完成挂载。
2.  **原文件修改验证**:
    -   在 `faq_base.txt` 原文件上直接修改营业时间。
    -   系统通过哈希校验识别出 `modified` 状态，自动执行“先删后插”逻辑，确保向量库中不留旧数据。
3.  **物理删除同步**:
    -   手动删除 `faq_add.txt`。
    -   同步后，再次查询相关问题，LLM 返回“无相关信息”，证明 `delete_ref_doc` 已成功从 Milvus 清理对应向量。

## 3. 技术深度分析

### 3.1. 基于哈希的状态管理
通过维护 `.state.json`，系统避免了每次启动都全量重建索引的开销。对于 1000+ 文件规模的知识库，这能将启动/同步时间从分钟级降低到秒级。

### 3.2. 自定义读写锁的必要性
在 Python 的异步/多线程环境下，原生 `Lock` 会导致读请求相互阻塞。本项目实现的 `ReadWriteLock` 允许在无写入时并发读取，极大提升了高并发下的系统吞吐量。

## 4. 总结

本实验证明了系统在保证检索准确性的基础上，具备了处理生产环境复杂情况（如数据频繁变动、并发访问）的能力。

**后续优化**:
- **RAG 检索性能调优**:
    - **切分策略优化**: 调优 `SemanticSplitter` 的超参数（如 `breakpoint_percentile_threshold`），或针对 FAQ 场景切换为“一问一答一 Node”的精确索引模式。
    - **混合检索 (Hybrid Search)**: 结合向量检索与 BM25 全文检索，提升对专有名词和缩写词的召回率。
- **系统监控与运维**: 增加 Prometheus 指标监控，实时观察同步延迟、检索耗时以及向量库利用率。

---

## 5. 系统调用指南

本系统通过 FastAPI 提供 RESTful API 接口，支持实时问答检索。

### 5.1. 环境启动
1. **启动 Milvus**:
   ```bash
   docker-compose up -d
   ```
2. **安装依赖**:
   ```bash
   cd week03-homework-2
   pip install -r milvus_faq/requirements.txt
   ```
3. **启动 API 服务**:
   ```bash
   python -m milvus_faq.main
   ```
   服务默认运行在 `http://127.0.0.1:8000`。

### 5.2. API 使用与调试

#### **交互式文档调试 (推荐)**
FastAPI 自带 Swagger UI，可以直接在浏览器中测试接口：
1. 访问 `http://127.0.0.1:8000/docs`。
2. 找到 `GET /query` 接口。
3. 点击 **Try it out**，在 `query` 框中输入你的问题（例如：`营业时间是什么时候？`）。
4. 点击 **Execute** 查看返回的 JSON 结果。

#### **Curl 调用示例**
如果你习惯使用命令行，可以运行以下命令（已处理 URL 编码）：
```bash
# 示例：查询营业时间
curl -X 'GET' 'http://127.0.0.1:8000/query?query=营业时间是什么时候？' -H 'accept: application/json'
```

### 5.3. 检索性能说明 (关于 Score)
在测试中，你可能会观察到类似 `0.3229` 的检索分数。
- **分数性质**: 这里的得分基于向量余弦距离或欧氏距离（取决于 Milvus 配置）。
- **性能分析**: 当前系统使用 `SemanticSplitter` 对 `.txt` 文件进行语义切分。对于 FAQ 这种“短文本问答”场景，语义切分有时会将多个问答对强行合并或拆分，导致检索得分看似不高（虽然 LLM 最终能给出正确回答）。
- **优化建议**: 为提升召回精度，建议将 `.txt` 格式化为每行一个“Q: ... A: ...”的结构，并切换为 **“一问一答一 Node”** 的精确索引策略，确保每个向量都代表一个完整的问答语义单元。

### 5.4. 数据管理
- **热更新**: 只需将新的 `.txt` 文件放入 `milvus_faq/data` 目录，系统后台线程会在 10 秒内自动完成扫描与索引同步。
- **状态追踪**: 根目录下的 `.file_state.json` 记录了已处理文件的哈希值，确保增量更新的高效性。
